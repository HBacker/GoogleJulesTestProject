@{
    ViewData["Title"] = "Kurs Arama";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container" style="margin-top: 30px; margin-bottom: 30px;">
    <h2>@ViewData["Title"]</h2>
    <form id="searchForm" class="mb-4">
        <div class="input-group">
            <input type="search" id="searchInput" class="form-control" placeholder="Aramak istediğiniz kurs adını girin..." aria-label="Kurs Ara">
            <button class="btn btn-primary" type="submit" id="searchButton">Ara</button>
        </div>
    </form>
    <div id="searchResultsContainer" class="custom-card-container">
    </div>
    <div class="alert alert-info mt-3" id="noSearchResultsMessage" style="display:none;">
        Aramanızla eşleşen kurs bulunamadı.
    </div>
    <div class="alert alert-secondary mt-3" id="emptySearchMessage" style="display:block;">
        Lütfen aramak için bir şeyler yazın.
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var apiBaseUrl = "@ViewBag.ApiBaseUrl";
            var token = localStorage.getItem("token"); 
            var defaultImageUrl = '/img/default-course.jpg'; 

            if (typeof notyf === 'undefined' && typeof Notyf !== 'undefined') {
                 window.notyf = new Notyf({
                    duration: 3000,
                    position: { x: 'right', y: 'top' }
                });
            } else if (typeof notyf === 'undefined' && typeof Notyf === 'undefined') {
                window.notyf = { 
                    error: function(msg){ console.error("Notyf.error: " + msg); }, 
                    success: function(msg){ console.log("Notyf.success: " + msg); },
                    info: function(msg){ console.log("Notyf.info: " + msg); } 
                };
            }

            function displaySearchResults(results) {
                var searchResultsContainer = $('#searchResultsContainer');
                searchResultsContainer.empty();
                $('#noSearchResultsMessage').hide();
                $('#emptySearchMessage').hide();

                if (!results || results.length === 0) {
                    $('#noSearchResultsMessage').show();
                    return;
                }

                $.each(results, function (i, course) {
                    var imageUrl = (course.photoUrl === '-' || !course.photoUrl) ? defaultImageUrl : '/uploads/courses/' + course.photoUrl;
                    var categoriesText = course.categories && course.categories.length > 0 ?
                        course.categories.map(c => c.name).join(', ') : 'Genel';
                    var courseTitle = course.title || 'Başlık Yok';
                    var courseDescription = course.description ? course.description.substring(0, 100) + '...' : 'Açıklama Yok';

                    var courseCard = `
                        <div class="custom-card">
                            <div class="custom-card-image">
                                <img src="${imageUrl}" alt="${courseTitle}" />
                            </div>
                            <div class="custom-card-content">
                                <span class="custom-card-category">${categoriesText}</span>
                                <h4>${courseTitle}</h4>
                                <p>${courseDescription}</p>
                                <div class="custom-card-footer">
                                    <a href="/Course/Details/${course.id}" class="btn btn-primary custom-readmore-btn">
                                        Daha Fazla <i class="fas fa-arrow-right"></i>
                                    </a>
                                </div>
                            </div>
                        </div>`;
                    searchResultsContainer.append(courseCard);
                });
            }

            $('#searchForm').on('submit', function (event) {
                event.preventDefault();
                var query = $('#searchInput').val().trim();
                var searchResultsContainer = $('#searchResultsContainer');
                
                $('#noSearchResultsMessage').hide();
                $('#emptySearchMessage').hide();

                if (!query) {
                    $('#emptySearchMessage').show();
                    searchResultsContainer.empty();
                    return;
                }
                
                const $searchButton = $('#searchButton');
                $searchButton.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Aranıyor...');

                $.ajax({
                    url: apiBaseUrl + '/courses?searchQuery=' + encodeURIComponent(query),
                    type: 'GET',
                    headers: {
                    },
                    success: function (data) {
                        displaySearchResults(data);
                    },
                    error: function (xhr, status, error) {
                        notyf.error("Kurslar aranırken bir hata oluştu. Lütfen tekrar deneyin.");
                        searchResultsContainer.empty();
                        $('#noSearchResultsMessage').text("Arama sırasında bir hata oluştu. Lütfen daha sonra tekrar deneyin.").show();
                    },
                    complete: function() {
                        $searchButton.prop('disabled', false).text('Ara');
                    }
                });
            });
        });
    </script>
}
